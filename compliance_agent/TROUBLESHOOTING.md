# 视频转录故障排除指南

## ❌ 常见错误及解决方案

### 错误1：Whisper 未安装

**错误信息：**
```
❌ [错误] Whisper 未安装，请运行: pip install openai-whisper
```

**解决方案：**
```bash
pip install openai-whisper
```

**说明：**
- Whisper 是 OpenAI 开发的语音识别库
- 需要先安装才能使用视频转录功能

---

### 错误2：Whisper 模型加载失败

**错误信息：**
```
❌ [错误] Whisper 模型加载失败，请检查系统资源
```

**可能原因：**
1. 系统内存不足
2. 磁盘空间不足
3. 网络问题（首次下载模型）

**解决方案：**
```bash
# 1. 检查内存
# 确保至少有 4GB 可用内存

# 2. 清理磁盘空间
# 删除不必要的文件

# 3. 手动下载模型
# 模型会自动下载到 ~/.cache/whisper/
```

---

### 错误3：视频文件不存在

**错误信息：**
```
❌ [错误] 视频文件不存在: [路径]
```

**解决方案：**
1. 确认文件路径正确
2. 检查文件扩展名是否正确
3. 尝试重新选择文件

---

### 错误4：视频转录失败 - 通用错误

**错误信息：**
```
❌ [错误] 视频转录失败: [错误类型] - [错误详情]
```

**可能原因及解决方案：**

#### 4.1 视频没有语音内容
- **检查方法：** 用播放器打开视频，确认是否有声音
- **解决方案：** 使用有语音的视频文件

#### 4.2 视频音频格式不支持
- **检查方法：** 查看视频编码信息
- **解决方案：** 转换视频格式
```bash
# 使用 FFmpeg 转换视频格式
ffmpeg -i input.mp4 -c:v libx264 -c:a aac output.mp4
```

#### 4.3 视频损坏
- **检查方法：** 尝试用其他播放器打开
- **解决方案：** 重新获取或转换视频

#### 4.5 系统资源不足
- **检查方法：** 查看任务管理器中的内存使用
- **解决方案：** 关闭其他程序或使用更小的模型

---

### 错误5：视频转录成功但未检测到语音内容

**提示信息：**
```
⚠️ [提示] 视频转录成功，但未检测到语音内容
```

**可能原因：**
1. 视频只有背景音乐
2. 视频音量太低
3. 语音不是中文

**解决方案：**
1. 提高视频音量
2. 确保视频包含中文语音
3. 手动在笔记文本框中输入文案

---

## 🔍 诊断步骤

### 步骤1：检查 Whisper 是否安装
```bash
python -c "import whisper; print('Whisper 已安装')"
```

**预期输出：** `Whisper 已安装`

**如果报错：** 需要安装 Whisper

---

### 步骤2：检查视频文件
```bash
# 检查文件是否存在
ls -lh [视频文件路径]

# 检查文件格式
ffprobe [视频文件路径]
```

---

### 步骤3：测试 Whisper
```bash
python -c "
import whisper
model = whisper.load_model('base')
print('Whisper 模型加载成功')
"
```

**预期输出：** `Whisper 模型加载成功`

---

### 步骤4：测试转录
```bash
python -c "
import whisper
model = whisper.load_model('base')
result = model.transcribe('[视频文件路径]')
print(result['text'])
"
```

---

## 💡 优化建议

### 1. 使用更大的 Whisper 模型

在 `src/config.py` 中修改：
```python
WHISPER_CONFIG = {
    "model_size": "small",  # 改为 small 或 medium
    "language": "zh",
    "task": "transcribe"
}
```

**模型对比：**
| 模型 | 大小 | 速度 | 准确率 |
|------|------|------|--------|
| tiny | ~40MB | 最快 | 较低 |
| base | ~75MB | 快 | 中等 |
| small | ~250MB | 中等 | 较高 |
| medium | ~770MB | 慢 | 高 |
| large | ~1550MB | 最慢 | 最高 |

---

### 2. 提高 Whisper 性能

```python
# 使用 GPU（如果可用）
model = whisper.load_model("base", device="cuda")

# 使用 FP16（减少内存）
model = whisper.load_model("base", device="cuda", fp16=True)
```

---

### 3. 预处理视频

```bash
# 提取音频
ffmpeg -i input.mp4 -vn -acodec pcm_s16le -ar 16000 -ac 1 audio.wav

# 转录音频
python -c "
import whisper
model = whisper.load_model('base')
result = model.transcribe('audio.wav')
print(result['text'])
"
```

---

## 📋 测试用例

### 测试1：纯语音视频
- **描述：** 只有语音，无背景音乐
- **预期结果：** ✅ 转录成功
- **验证方法：** 检查转录文本是否与语音一致

### 测试2：带背景音乐的视频
- **描述：** 语音 + 背景音乐
- **预期结果：** ✅ 转录成功（可能包含音乐描述）
- **验证方法：** 检查转录文本是否包含语音内容

### 测试3：无语音视频
- **描述：** 只有背景音乐或无声音
- **预期结果：** ⚠️ 未检测到语音内容
- **验证方法：** 检查是否显示提示信息

### 测试4：非中文语音
- **描述：** 英文或其他语言语音
- **预期结果：** ⚠️ 转录结果为空或不准确
- **验证方法：** 检查转录文本是否为空

---

## 🆘 获取帮助

如果以上方法都无法解决问题：

1. **查看日志文件：** `logs/compliance_agent.log`
2. **检查系统资源：** 内存、磁盘空间
3. **更新依赖：** `pip install --upgrade openai-whisper`
4. **重启应用：** 完全退出后重新启动

---

## 📝 总结

| 问题 | 检查方法 | 解决方案 |
|------|----------|----------|
| Whisper 未安装 | 运行导入测试 | `pip install openai-whisper` |
| 模型加载失败 | 检查系统资源 | 关闭其他程序，增加内存 |
| 视频文件不存在 | 检查文件路径 | 重新选择文件 |
| 视频无语音 | 播放视频确认 | 使用有语音的视频 |
| 音频格式不支持 | 使用 FFmpeg 检查 | 转换视频格式 |
| 转录不准确 | 对比语音和文本 | 使用更大的模型 |
